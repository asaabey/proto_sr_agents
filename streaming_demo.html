<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systematic Review Auditor - Live Streaming Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .log-container {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .log-entry.agent-start {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .log-entry.agent-complete {
            background-color: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }

        .log-entry.progress {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .log-entry.complete {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }

        .log-entry.error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background: #1976D2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-input {
            margin: 10px 0;
        }

        .results {
            margin-top: 20px;
            display: none;
        }

        .results.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Systematic Review Auditor</h1>
        <p>Upload a systematic review manuscript (DOCX) and watch the live analysis progress.</p>

        <div class="controls">
            <input type="file" id="fileInput" accept=".docx,.doc" class="file-input">
            <button id="startBtn">Start Analysis</button>
            <button id="stopBtn" disabled>Stop</button>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">Ready to start analysis</div>
        </div>

        <div class="log-container" id="logContainer">
            <div class="log-entry">Waiting for analysis to start...</div>
        </div>

        <div class="results" id="results">
            <h2>Analysis Results</h2>
            <pre id="resultsContent"></pre>
        </div>
    </div>

    <script>
        let eventSource = null;
        const logContainer = document.getElementById('logContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');

        // Agent progress mapping
        const agentProgress = {
            'PICO Parser': 25,
            'PRISMA Checker': 50,
            'Risk of Bias Assessor': 75,
            'Meta-Analysis': 100
        };

        function addLogEntry(eventType, message, agent = null, data = null) {
            const entry = document.createElement('div');
            entry.className = `log-entry ${eventType.replace('_', '-')}`;

            const timestamp = new Date().toLocaleTimeString();
            let content = `[${timestamp}] `;

            if (agent) {
                content += `${agent}: `;
            }

            content += message;

            if (data) {
                if (data.issues_found !== undefined) {
                    content += ` (${data.issues_found} issues found)`;
                }
                if (data.total_issues !== undefined) {
                    content += ` - Total: ${data.total_issues} issues`;
                }
            }

            entry.textContent = content;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(agent, eventType) {
            if (eventType === 'agent_start') {
                const progress = agentProgress[agent] || 0;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Running ${agent}...`;
            } else if (eventType === 'complete') {
                progressFill.style.width = '100%';
                progressText.textContent = 'Analysis complete!';
            }
        }

        function startStreamingAnalysis(file) {
            if (eventSource) {
                eventSource.close();
            }

            // Clear previous results
            logContainer.innerHTML = '';
            progressFill.style.width = '0%';
            results.classList.remove('show');

            const formData = new FormData();
            formData.append('file', file);

            // Start the streaming request
            fetch('/review/upload/stream', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Create EventSource from the response
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    function readStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                addLogEntry('complete', 'Stream ended');
                                return;
                            }

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.substring(6));
                                        addLogEntry(data.event_type, data.message, data.agent, data.data);
                                        updateProgress(data.agent, data.event_type);

                                        if (data.event_type === 'complete') {
                                            // Store final results
                                            resultsContent.textContent = JSON.stringify(data.data, null, 2);
                                            results.classList.add('show');
                                        }
                                    } catch (e) {
                                        console.error('Error parsing SSE data:', e);
                                    }
                                }
                            }

                            readStream();
                        });
                    }

                    readStream();
                })
                .catch(error => {
                    addLogEntry('error', `Analysis failed: ${error.message}`);
                    progressText.textContent = 'Analysis failed';
                });
        }

        startBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }

            startBtn.disabled = true;
            stopBtn.disabled = false;
            startStreamingAnalysis(file);
        });

        stopBtn.addEventListener('click', () => {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;
            addLogEntry('progress', 'Analysis stopped by user');
            progressText.textContent = 'Analysis stopped';
        });

        // Enable start button when file is selected
        fileInput.addEventListener('change', () => {
            startBtn.disabled = !fileInput.files[0];
        });
    </script>
</body>

</html>